<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è°ƒè¯•é¡µé¢ - è”ç³»æˆ‘</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">è°ƒè¯•é¡µé¢</h1>
    
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Supabase è¿æ¥æµ‹è¯•</h2>
      <button id="testConnection" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
        æµ‹è¯•è¿æ¥
      </button>
      <div id="connectionResult" class="mt-4 p-4 bg-gray-50 rounded hidden"></div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">ç”¨æˆ·æ³¨å†Œæµ‹è¯•</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">é‚®ç®±</label>
          <input id="testEmail" type="email" class="w-full px-3 py-2 border rounded" placeholder="test@example.com">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">å¯†ç </label>
          <input id="testPassword" type="password" class="w-full px-3 py-2 border rounded" placeholder="è‡³å°‘6ä½">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">å§“å</label>
          <input id="testName" type="text" class="w-full px-3 py-2 border rounded" placeholder="æµ‹è¯•ç”¨æˆ·">
        </div>
        <button id="testSignup" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500">
          æµ‹è¯•æ³¨å†Œ
        </button>
      </div>
      <div id="signupResult" class="mt-4 p-4 bg-gray-50 rounded hidden"></div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">æ•°æ®åº“è¡¨æ£€æŸ¥</h2>
      <button id="checkTables" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-500">
        æ£€æŸ¥è¡¨ç»“æ„
      </button>
      <div id="tablesResult" class="mt-4 p-4 bg-gray-50 rounded hidden"></div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold mb-4">æ§åˆ¶å°æ—¥å¿—</h2>
      <div id="consoleLog" class="h-64 overflow-y-auto bg-black text-green-400 p-4 rounded font-mono text-sm"></div>
    </div>
  </div>

  <script src="/js/config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    const cfg = window.__APP_CONFIG__;
    let supabase = null;

    function $(sel) { return document.querySelector(sel); }
    function log(message) {
      const console = $('#consoleLog');
      const time = new Date().toLocaleTimeString();
      console.innerHTML += `[${time}] ${message}\n`;
      console.scrollTop = console.scrollHeight;
    }

    async function init() {
      if (!cfg.supabaseUrl || !cfg.supabaseKey) {
        log('âŒ Supabaseé…ç½®ç¼ºå¤±');
        return;
      }
      
      supabase = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseKey);
      log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
      
      setupEventListeners();
    }

    function setupEventListeners() {
      $('#testConnection').addEventListener('click', testConnection);
      $('#testSignup').addEventListener('click', testSignup);
      $('#checkTables').addEventListener('click', checkTables);
    }

    async function testConnection() {
      log('ğŸ” æµ‹è¯•Supabaseè¿æ¥...');
      try {
        const { data, error } = await supabase.from('templates').select('count').limit(1);
        if (error) {
          log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
          $('#connectionResult').innerHTML = `<div class="text-red-600">è¿æ¥å¤±è´¥: ${error.message}</div>`;
        } else {
          log('âœ… è¿æ¥æˆåŠŸ');
          $('#connectionResult').innerHTML = '<div class="text-green-600">è¿æ¥æˆåŠŸï¼</div>';
        }
      } catch (err) {
        log(`âŒ è¿æ¥å¼‚å¸¸: ${err.message}`);
        $('#connectionResult').innerHTML = `<div class="text-red-600">è¿æ¥å¼‚å¸¸: ${err.message}</div>`;
      }
      $('#connectionResult').classList.remove('hidden');
    }

    async function testSignup() {
      const email = $('#testEmail').value;
      const password = $('#testPassword').value;
      const name = $('#testName').value;

      if (!email || !password || !name) {
        log('âŒ è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
        return;
      }

      log(`ğŸ” æµ‹è¯•æ³¨å†Œç”¨æˆ·: ${email}`);
      try {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: { name }
          }
        });

        if (error) {
          log(`âŒ æ³¨å†Œå¤±è´¥: ${error.message}`);
          $('#signupResult').innerHTML = `<div class="text-red-600">æ³¨å†Œå¤±è´¥: ${error.message}</div>`;
        } else {
          log(`âœ… æ³¨å†ŒæˆåŠŸ: ${data.user?.id}`);
          log(`ğŸ“§ é‚®ç®±ç¡®è®¤çŠ¶æ€: ${data.user?.email_confirmed_at ? 'å·²ç¡®è®¤' : 'å¾…ç¡®è®¤'}`);
          
          // å°è¯•åˆ›å»ºç”¨æˆ·èµ„æ–™
          if (data.user) {
            log('ğŸ” åˆ›å»ºç”¨æˆ·èµ„æ–™...');
            const { error: profileError } = await supabase
              .from('user_profiles')
              .insert({
                id: data.user.id,
                email: email,
                name: name
              });
            
            if (profileError) {
              log(`âŒ ç”¨æˆ·èµ„æ–™åˆ›å»ºå¤±è´¥: ${profileError.message}`);
            } else {
              log('âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ');
            }
          }
          
          $('#signupResult').innerHTML = '<div class="text-green-600">æ³¨å†ŒæˆåŠŸï¼</div>';
        }
      } catch (err) {
        log(`âŒ æ³¨å†Œå¼‚å¸¸: ${err.message}`);
        $('#signupResult').innerHTML = `<div class="text-red-600">æ³¨å†Œå¼‚å¸¸: ${err.message}</div>`;
      }
      $('#signupResult').classList.remove('hidden');
    }

    async function checkTables() {
      log('ğŸ” æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„...');
      const tables = ['user_profiles', 'profiles', 'products', 'socials', 'templates'];
      
      for (const table of tables) {
        try {
          const { data, error } = await supabase.from(table).select('*').limit(1);
          if (error) {
            log(`âŒ è¡¨ ${table} ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ${error.message}`);
          } else {
            log(`âœ… è¡¨ ${table} å­˜åœ¨`);
          }
        } catch (err) {
          log(`âŒ æ£€æŸ¥è¡¨ ${table} å¼‚å¸¸: ${err.message}`);
        }
      }
      
      $('#tablesResult').innerHTML = '<div class="text-green-600">æ£€æŸ¥å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—</div>';
      $('#tablesResult').classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
