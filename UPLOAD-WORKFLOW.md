# 图片上传工作流程

## 🎯 整体架构

```
┌─────────────┐      ┌──────────────┐      ┌─────────────┐
│             │      │              │      │             │
│  用户浏览器  │─────▶│  上传组件     │─────▶│  Supabase   │
│             │      │  upload.js   │      │  Storage    │
│             │      │              │      │             │
└─────────────┘      └──────────────┘      └─────────────┘
      ▲                     │                      │
      │                     ▼                      │
      │              ┌──────────────┐              │
      └──────────────│  预览 & URL  │◀─────────────┘
                     └──────────────┘
```

## 📝 详细流程

### 1️⃣ 用户上传流程

```
用户操作
  │
  ├─ 点击"上传图片"按钮
  │
  ├─ 选择本地文件
  │
  ├─ 文件选择完成
  │
  ▼
系统处理
  │
  ├─ 验证文件类型
  │   ├─ 是图片？
  │   │   ├─ 是 → 继续
  │   │   └─ 否 → ❌ 提示"请上传图片文件"
  │
  ├─ 验证文件大小
  │   ├─ ≤ 5MB？
  │   │   ├─ 是 → 继续
  │   │   └─ 否 → ❌ 提示"文件过大"
  │
  ├─ 生成唯一文件名
  │   └─ {timestamp}-{random}.{ext}
  │
  ├─ 显示进度条 (0%)
  │
  ├─ 上传到 Supabase Storage
  │   ├─ 进度更新 (0% → 100%)
  │   └─ 上传完成
  │
  ├─ 获取公共 URL
  │
  ├─ 更新输入框值
  │
  ├─ 更新预览图片
  │
  ├─ 触发自动保存
  │
  └─ ✅ 显示成功提示
```

### 2️⃣ 文件验证流程

```
┌─────────────┐
│ 用户选择文件 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 检查文件类型 │
└──────┬──────┘
       │
       ├─ image/jpeg     ✅
       ├─ image/png      ✅
       ├─ image/gif      ✅
       ├─ image/webp     ✅
       ├─ image/svg+xml  ✅
       └─ 其他            ❌
       │
       ▼
┌─────────────┐
│ 检查文件大小 │
└──────┬──────┘
       │
       ├─ ≤ 5MB          ✅
       └─ > 5MB          ❌
       │
       ▼
┌─────────────┐
│ 开始上传     │
└─────────────┘
```

### 3️⃣ 上传进度显示

```
阶段 1: 准备上传
┌────────────────────────────┐
│ [📤 上传图片]              │
└────────────────────────────┘

阶段 2: 上传中 (0-99%)
┌────────────────────────────┐
│ [███████░░░░░░░░░░░] 35%   │
└────────────────────────────┘

阶段 3: 上传完成
┌────────────────────────────┐
│ [📤 上传图片]              │
└────────────────────────────┘
     +
┌────────────────────────────┐
│ ✅ 上传成功                │
└────────────────────────────┘
```

### 4️⃣ 预览更新流程

```
头像上传
  │
  ├─ 上传成功 → 获取 URL
  │
  ├─ 更新 #avatarPreview (圆形预览)
  │
  ├─ 更新 #userAvatar (导航栏头像)
  │
  └─ 更新 #profileAvatar (输入框)

二维码上传
  │
  ├─ 上传成功 → 获取 URL
  │
  ├─ 更新 #qrPreview (方形预览)
  │
  ├─ 显示预览容器
  │
  └─ 更新 #socialQr (输入框)

产品图片上传
  │
  ├─ 上传成功 → 获取 URL
  │
  ├─ 更新 #productImagePreview (横向预览)
  │
  ├─ 显示预览容器
  │
  └─ 更新 #productImage (输入框)
```

### 5️⃣ 数据保存流程

```
上传完成
  │
  ├─ 触发 input.blur 事件
  │
  ▼
dashboard.js
  │
  ├─ 监听到 blur 事件
  │
  ├─ 调用 saveProfile()
  │
  ▼
保存到数据库
  │
  ├─ 准备数据
  │   └─ { avatar_url: "https://..." }
  │
  ├─ 检查 currentProfile
  │   ├─ 存在 → UPDATE
  │   └─ 不存在 → INSERT
  │
  ├─ 执行 Supabase 查询
  │
  └─ ✅ 保存成功
```

## 🔄 状态转换

### 上传按钮状态

```
[待机] ─────┬──────────────────────────┐
    ▲       │ 点击                      │
    │       ▼                          │
    │   [选择文件]                      │
    │       │                          │
    │       ▼                          │
    │   [验证中]                        │
    │       │                          │
    │       ├─ 失败 ──▶ [错误] ────────┤
    │       │                          │
    │       ▼                          │
    │   [上传中] ◀─── 显示进度条         │
    │       │                          │
    │       ├─ 失败 ──▶ [错误] ────────┤
    │       │                          │
    │       ▼                          │
    │   [成功] ─────────────────────────┘
    │       │
    │       ▼
    └─── [待机] (自动返回)
```

### 预览图片状态

```
[默认图片]
    │
    ├─ 上传成功
    │
    ▼
[用户图片]
    │
    ├─ 鼠标悬停
    │
    ▼
[放大显示]
    │
    ├─ 鼠标离开
    │
    ▼
[用户图片]
```

## 📊 数据流

### 完整数据流程图

```
用户操作
    │
    ▼
┌─────────────┐
│  选择文件    │  File Object
└─────┬───────┘
      │
      ▼
┌─────────────┐
│  前端验证    │  Type, Size Check
└─────┬───────┘
      │
      ▼
┌─────────────┐
│ 生成文件名   │  {timestamp}-{random}.{ext}
└─────┬───────┘
      │
      ▼
┌─────────────┐
│ 上传到存储   │  Supabase Storage API
└─────┬───────┘
      │
      ▼
┌─────────────┐
│ 获取 URL     │  Public URL
└─────┬───────┘
      │
      ├────────────────┐
      │                │
      ▼                ▼
┌─────────────┐  ┌─────────────┐
│ 更新输入框   │  │ 更新预览图   │
└─────┬───────┘  └─────────────┘
      │
      ▼
┌─────────────┐
│ 保存到数据库 │  Supabase Database
└─────┬───────┘
      │
      ▼
┌─────────────┐
│  完成        │
└─────────────┘
```

## 🎨 UI 交互时序

```
时间轴
  │
  0s  ├─ 用户点击"上传图片"
  │   │
0.1s  ├─ 弹出文件选择器
  │   │
  2s  ├─ 用户选择文件
  │   │
2.1s  ├─ 开始验证
  │   │
2.2s  ├─ 验证通过
  │   │
2.3s  ├─ 显示进度条 (0%)
  │   │
2.5s  ├─ 开始上传
  │   │
3.0s  ├─ 进度更新 (20%)
  │   │
3.5s  ├─ 进度更新 (50%)
  │   │
4.0s  ├─ 进度更新 (80%)
  │   │
4.5s  ├─ 上传完成 (100%)
  │   │
4.6s  ├─ 获取 URL
  │   │
4.7s  ├─ 更新预览
  │   │
4.8s  ├─ 隐藏进度条
  │   │
4.9s  ├─ 显示成功提示
  │   │
5.0s  ├─ 自动保存
  │   │
5.2s  ├─ 完成
  │
```

## 🔧 关键函数调用链

### 头像上传

```
用户点击按钮
  │
  ▼
uploadBtn.click()
  │
  ▼
fileInput.click()
  │
  ▼
fileInput.change 事件
  │
  ▼
uploadToSupabase(file, onProgress)
  │
  ├─ 验证文件
  ├─ 生成文件名
  ├─ supabase.storage.upload()
  └─ supabase.storage.getPublicUrl()
  │
  ▼
onSuccess(url)
  │
  ├─ input.value = url
  ├─ preview.src = url
  └─ input.dispatchEvent('blur')
  │
  ▼
saveProfile()
  │
  ├─ 准备 profileData
  └─ supabase.from('profiles').update()
  │
  ▼
完成
```

## 🛡️ 错误处理流程

```
上传过程
  │
  ├─ 文件类型错误
  │   └─ throw Error("请上传图片文件")
  │       └─ catch → onError → showToast(error, 'error')
  │
  ├─ 文件大小错误
  │   └─ throw Error("图片大小不能超过 5MB")
  │       └─ catch → onError → showToast(error, 'error')
  │
  ├─ 网络错误
  │   └─ Supabase 错误
  │       └─ catch → onError → showToast("上传失败", 'error')
  │
  └─ 未知错误
      └─ catch → onError → showToast("上传失败", 'error')
```

## 📱 响应式适配流程

```
检测屏幕宽度
  │
  ├─ >= 1024px (桌面端)
  │   ├─ 头像预览: 80x80
  │   ├─ 按钮: 正常大小
  │   └─ 预览: 横向布局
  │
  ├─ 768px - 1023px (平板)
  │   ├─ 头像预览: 70x70
  │   ├─ 按钮: 正常大小
  │   └─ 预览: 纵向布局
  │
  └─ < 768px (手机)
      ├─ 头像预览: 60x60
      ├─ 按钮: 全宽显示
      └─ 预览: 纵向布局
```

## 🎯 性能优化点

```
文件处理
  │
  ├─ 客户端验证 (立即反馈)
  │   └─ 避免无效上传
  │
  ├─ 进度显示 (用户体验)
  │   └─ 感知性能提升
  │
  ├─ 异步上传 (非阻塞)
  │   └─ 页面保持响应
  │
  └─ 自动保存 (减少操作)
      └─ 用户无需手动保存
```

---

**流程图版本**: 1.0  
**更新日期**: 2025-10-14  
**适用范围**: Dashboard 图片上传功能
