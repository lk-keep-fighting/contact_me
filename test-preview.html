<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é¢„è§ˆæµ‹è¯• - è”ç³»æˆ‘</title>
  <script src="/assets/vendor/tailwindcss/tailwindcss.js"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">é¢„è§ˆåŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">æµ‹è¯•é¢„è§ˆé“¾æ¥</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">é¡µé¢æ ‡è¯† (handle)</label>
          <input id="testHandle" type="text" class="w-full px-3 py-2 border rounded" placeholder="è¾“å…¥é¡µé¢æ ‡è¯†" value="demo">
        </div>
        <div class="flex space-x-4">
          <button id="testPreview" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
            æµ‹è¯•é¢„è§ˆ
          </button>
          <button id="testDirect" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500">
            ç›´æ¥è®¿é—®
          </button>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">é¢„è§ˆç»“æœ</h2>
      <div id="previewResult" class="bg-gray-50 p-4 rounded">
        <p class="text-gray-500">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯•é¢„è§ˆåŠŸèƒ½</p>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold mb-4">è°ƒè¯•ä¿¡æ¯</h2>
      <div id="debugInfo" class="bg-black text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
        <p>ç­‰å¾…æµ‹è¯•...</p>
      </div>
    </div>
  </div>

  <script src="/js/config.js"></script>
  <script src="/assets/vendor/supabase/supabase.js"></script>
  <script>
    const cfg = window.__APP_CONFIG__;
    let supabase = null;

    function $(sel) { return document.querySelector(sel); }
    function log(message) {
      const debug = $('#debugInfo');
      const time = new Date().toLocaleTimeString();
      debug.innerHTML += `[${time}] ${message}\n`;
      debug.scrollTop = debug.scrollHeight;
    }

    async function init() {
      if (!cfg.supabaseUrl || !cfg.supabaseKey) {
        log('âŒ Supabaseé…ç½®ç¼ºå¤±');
        return;
      }
      
      supabase = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseKey);
      log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
      
      setupEventListeners();
    }

    function setupEventListeners() {
      $('#testPreview').addEventListener('click', testPreview);
      $('#testDirect').addEventListener('click', testDirect);
    }

    async function testPreview() {
      const handle = $('#testHandle').value;
      if (!handle) {
        log('âŒ è¯·è¾“å…¥é¡µé¢æ ‡è¯†');
        return;
      }

      log(`ğŸ” æµ‹è¯•é¢„è§ˆ: ${handle}`);
      
      try {
        // æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥handle
        const { data, error } = await supabase
          .from('profiles')
          .select('*, products(*), socials(*)')
          .eq('handle', handle)
          .single();
        
        if (error) {
          log(`âŒ æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${error.message}`);
          $('#previewResult').innerHTML = `<div class="text-red-600">æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
          return;
        }
        
        if (!data) {
          log(`âŒ æœªæ‰¾åˆ°é¡µé¢: ${handle}`);
          $('#previewResult').innerHTML = `<div class="text-red-600">æœªæ‰¾åˆ°é¡µé¢: ${handle}</div>`;
          return;
        }
        
        log(`âœ… æ‰¾åˆ°é¡µé¢æ•°æ®: ${data.name}`);
        $('#previewResult').innerHTML = `
          <div class="text-green-600">
            <h3 class="font-semibold">æ‰¾åˆ°é¡µé¢æ•°æ®</h3>
            <p>åç§°: ${data.name}</p>
            <p>æ ‡é¢˜: ${data.title || 'æ— '}</p>
            <p>äº§å“æ•°é‡: ${data.products?.length || 0}</p>
            <p>ç¤¾äº¤é“¾æ¥æ•°é‡: ${data.socials?.length || 0}</p>
            <p>å‘å¸ƒçŠ¶æ€: ${data.is_published ? 'å·²å‘å¸ƒ' : 'æœªå‘å¸ƒ'}</p>
          </div>
        `;
        
        // æ‰“å¼€é¢„è§ˆé¡µé¢
        const url = `/profile.html?handle=${handle}&preview=true`;
        log(`ğŸ”— æ‰“å¼€é¢„è§ˆé¡µé¢: ${url}`);
        window.open(url, '_blank');
        
      } catch (err) {
        log(`âŒ æµ‹è¯•å¼‚å¸¸: ${err.message}`);
        $('#previewResult').innerHTML = `<div class="text-red-600">æµ‹è¯•å¼‚å¸¸: ${err.message}</div>`;
      }
    }

    async function testDirect() {
      const handle = $('#testHandle').value;
      if (!handle) {
        log('âŒ è¯·è¾“å…¥é¡µé¢æ ‡è¯†');
        return;
      }

      const url = `/profile.html?handle=${handle}`;
      log(`ğŸ”— ç›´æ¥è®¿é—®: ${url}`);
      window.open(url, '_blank');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
